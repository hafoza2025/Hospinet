<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Secretary Portal</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h2>üìã Secretary Portal</h2>
            <div class="actions">
                <span id="userName" style="margin-right:12px;font-weight:500;color:var(--gray-700)"></span>
                <button class="btn" id="refreshBtn">üîÑ Refresh</button>
                <button class="btn btn-secondary" id="logoutBtn">üö™ Logout</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-label">Total Patients</div>
                <div class="stat-card-value" id="totalPatients">0</div>
            </div>
            <div class="stat-card success">
                <div class="stat-card-label">Active Patients</div>
                <div class="stat-card-value" id="activePatients">0</div>
            </div>
            <div class="stat-card primary">
                <div class="stat-card-label">Registered Today</div>
                <div class="stat-card-value" id="todayPatients">0</div>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <h3>Patient Management</h3>
                <button class="btn btn-primary" id="addPatientBtn">‚ûï Register New Patient</button>
            </div>

            <div class="form-group">
                <input class="input" id="search" placeholder="üîç Search patients by name or phone..." />
            </div>

            <div id="patientsList" class="list"></div>
        </div>
    </div>

    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>‚ûï Register New Patient</h3>
                <button class="btn btn-secondary" id="closePatientModal">‚úï Close</button>
            </div>

            <form id="patientForm" class="modal-body">
                <h4>Basic Information</h4>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="patientName" class="input" required />
                    </div>
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" id="patientDOB" class="input" required />
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Gender *</label>
                        <select id="patientGender" class="input" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" id="patientPhone" class="input" required />
                    </div>
                </div>

                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="patientAddress" class="input" />
                </div>

                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Insurance Provider</label>
                        <input type="text" id="patientInsurance" class="input" />
                    </div>
                    <div class="form-group">
                        <label>Allergies</label>
                        <input type="text" id="patientAllergies" class="input"
                            placeholder="e.g., Penicillin, Aspirin" />
                    </div>
                </div>

                <div class="form-group">
                    <label>Assign to Doctor *</label>
                    <select id="patientDoctor" class="input" required>
                        <option value="">Select Doctor</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="patientNotes" class="input" rows="3" placeholder="Additional notes..."></textarea>
                </div>
            </form>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelPatient">Cancel</button>
                <button class="btn btn-primary" id="submitPatient">‚úÖ Register Patient</button>
            </div>
        </div>
    </div>

    <!-- View Patient Modal -->
    <div id="viewPatientModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>üë§ Patient Details</h3>
                <button class="btn btn-secondary" id="closeViewModal">‚úï Close</button>
            </div>

            <div class="modal-body">
                <div class="detail-card">
                    <div class="detail-card-header">
                        <div class="detail-card-title">Basic Information</div>
                    </div>
                    <div class="grid grid-3">
                        <div class="detail-section">
                            <span class="detail-label">Full Name</span>
                            <div class="detail-value" id="viewName">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Date of Birth</span>
                            <div class="detail-value" id="viewDOB">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Gender</span>
                            <div class="detail-value" id="viewGender">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Phone</span>
                            <div class="detail-value" id="viewPhone">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Address</span>
                            <div class="detail-value" id="viewAddress">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Status</span>
                            <div class="detail-value" id="viewStatus">-</div>
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-header">
                        <div class="detail-card-title">Medical Information</div>
                    </div>
                    <div class="grid grid-2">
                        <div class="detail-section">
                            <span class="detail-label">Insurance</span>
                            <div class="detail-value" id="viewInsurance">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Allergies</span>
                            <div class="detail-value" id="viewAllergies" style="border-left-color:var(--danger)">-</div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <span class="detail-label">Notes</span>
                        <div class="detail-value" id="viewNotes">-</div>
                    </div>
                </div>

                <div class="detail-card">
                    <div class="detail-card-header">
                        <div class="detail-card-title">Assignment</div>
                    </div>
                    <div class="grid grid-2">
                        <div class="detail-section">
                            <span class="detail-label">Assigned Doctor</span>
                            <div class="detail-value" id="viewDoctor">-</div>
                        </div>
                        <div class="detail-section">
                            <span class="detail-label">Registration Date</span>
                            <div class="detail-value" id="viewCreated">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="editPatientBtn">‚úèÔ∏è Edit</button>
                <button class="btn btn-primary" id="printPatientCard">üñ®Ô∏è Print Patient Card</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config.js"></script>
    <script src="../app.js"></script>

    <script>
        (async function () {
            const userStr = sessionStorage.getItem('user');
            if (!userStr) {
                alert('‚ö†Ô∏è Please sign in first');
                location.href = '../index.html';
                return;
            }

            const user = JSON.parse(userStr);
            if (user.role !== 'secretary' && user.role !== 'admin') {
                alert('‚ö†Ô∏è Unauthorized');
                location.href = '../index.html';
                return;
            }

            document.getElementById('userName').textContent = `üë§ ${user.full_name}`;

            let doctors = [];
            let patients = [];
            let currentPatient = null;

            await loadDoctors();
            await loadPatients();
            await updateStats();

            async function loadDoctors() {
                const allUsers = await App.readJSON('users');
                doctors = allUsers.filter(u => u.role === 'doctor' && u.status === 'active');

                const select = document.getElementById('patientDoctor');
                select.innerHTML = '<option value="">Select Doctor</option>';
                doctors.forEach(doc => {
                    const opt = document.createElement('option');
                    opt.value = doc.id;
                    opt.textContent = `Dr. ${doc.full_name}${doc.specialization ? ' - ' + doc.specialization : ''}`;
                    select.appendChild(opt);
                });
            }

            async function loadPatients() {
                patients = await App.readJSON('patients');
                renderPatients(patients);
            }

            async function updateStats() {
                const today = new Date().toISOString().split('T')[0];
                const active = patients.filter(p => p.status === 'active').length;
                const todayCount = patients.filter(p => p.created_at.startsWith(today)).length;

                document.getElementById('totalPatients').textContent = patients.length;
                document.getElementById('activePatients').textContent = active;
                document.getElementById('todayPatients').textContent = todayCount;
            }

            function renderPatients(list) {
                const container = document.getElementById('patientsList');
                container.innerHTML = '';

                if (list.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-title">No Patients Yet</div><div class="empty-state-description">Click "Register New Patient" to add your first patient</div></div>';
                    return;
                }

                list.forEach(p => {
                    const doctor = doctors.find(d => d.id === p.assigned_doctor_id);

                    const card = document.createElement('div');
                    card.className = 'detail-card';
                    card.style.cursor = 'pointer';

                    card.innerHTML = `
            <div class="detail-card-header">
              <div class="detail-card-title">üë§ ${p.basic_info.name}</div>
              <span class="badge ${p.status === 'active' ? '' : 'badge-warning'}">${p.status}</span>
            </div>
            <div class="grid grid-4">
              <div class="detail-section">
                <span class="detail-label">DOB</span>
                <div style="font-weight:500;color:var(--gray-800)">${App.formatDateShort(p.basic_info.dob) || '-'}</div>
              </div>
              <div class="detail-section">
                <span class="detail-label">Gender</span>
                <div style="font-weight:500;color:var(--gray-800)">${p.basic_info.gender || '-'}</div>
              </div>
              <div class="detail-section">
                <span class="detail-label">Phone</span>
                <div style="font-weight:500;color:var(--gray-800)">${p.basic_info.phone || '-'}</div>
              </div>
              <div class="detail-section">
                <span class="detail-label">Doctor</span>
                <div style="font-weight:500;color:var(--gray-800)">${doctor ? 'Dr. ' + doctor.full_name : '-'}</div>
              </div>
            </div>
          `;

                    card.onclick = () => viewPatient(p);
                    container.appendChild(card);
                });
            }

            function viewPatient(patient) {
                currentPatient = patient;
                const doctor = doctors.find(d => d.id === patient.assigned_doctor_id);

                document.getElementById('viewName').textContent = patient.basic_info.name;
                document.getElementById('viewDOB').textContent = App.formatDateShort(patient.basic_info.dob) || '-';
                document.getElementById('viewGender').textContent = patient.basic_info.gender || '-';
                document.getElementById('viewPhone').textContent = patient.basic_info.phone || '-';
                document.getElementById('viewAddress').textContent = patient.basic_info.address || '-';
                document.getElementById('viewStatus').innerHTML = `<span class="badge">${patient.status}</span>`;
                document.getElementById('viewInsurance').textContent = patient.basic_info.insurance || 'None';
                document.getElementById('viewAllergies').textContent = patient.basic_info.allergies || 'None';
                document.getElementById('viewNotes').textContent = patient.basic_info.notes || '-';
                document.getElementById('viewDoctor').textContent = doctor ? `Dr. ${doctor.full_name}` : '-';
                document.getElementById('viewCreated').textContent = App.formatDate(patient.created_at);

                document.getElementById('viewPatientModal').classList.add('active');
            }

            document.getElementById('search').oninput = (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) {
                    renderPatients(patients);
                    return;
                }

                const filtered = patients.filter(p =>
                    p.basic_info.name.toLowerCase().includes(query) ||
                    (p.basic_info.phone && p.basic_info.phone.includes(query))
                );
                renderPatients(filtered);
            };

            document.getElementById('addPatientBtn').onclick = () => {
                document.getElementById('addPatientModal').classList.add('active');
            };

            document.getElementById('closePatientModal').onclick = () => {
                document.getElementById('addPatientModal').classList.remove('active');
            };

            document.getElementById('cancelPatient').onclick = () => {
                document.getElementById('addPatientModal').classList.remove('active');
            };

            document.getElementById('closeViewModal').onclick = () => {
                document.getElementById('viewPatientModal').classList.remove('active');
            };

            document.getElementById('submitPatient').onclick = async () => {
                const data = {
                    name: document.getElementById('patientName').value.trim(),
                    dob: document.getElementById('patientDOB').value,
                    gender: document.getElementById('patientGender').value,
                    phone: document.getElementById('patientPhone').value.trim(),
                    address: document.getElementById('patientAddress').value.trim(),
                    insurance: document.getElementById('patientInsurance').value.trim(),
                    allergies: document.getElementById('patientAllergies').value.trim(),
                    notes: document.getElementById('patientNotes').value.trim()
                };

                const doctorId = document.getElementById('patientDoctor').value;

                if (!data.name || !data.dob || !data.gender || !data.phone || !doctorId) {
                    alert('‚ùå Please fill all required fields');
                    return;
                }

                const newPatient = {
                    id: App.uid('p'),
                    basic_info: data,
                    assigned_doctor_id: doctorId,
                    status: 'active',
                    created_at: App.timestamp()
                };

                await App.addRecord('patients', newPatient);
                await App.logAudit('patient_registered', user.id, { patientId: newPatient.id, patientName: data.name });

                App.showToast('Success', 'Patient registered successfully', 'success');
                document.getElementById('addPatientModal').classList.remove('active');
                document.getElementById('patientForm').reset();

                await loadPatients();
                await updateStats();
            };

            document.getElementById('printPatientCard').onclick = () => {
                if (!currentPatient) return;

                const doctor = doctors.find(d => d.id === currentPatient.assigned_doctor_id);
                const settings = {}; // ŸäŸÖŸÉŸÜ ÿ¨ŸÑÿ®Ÿáÿß ŸÖŸÜ getSettings()

                const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient Card - ${currentPatient.basic_info.name}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .card { border: 2px solid #0891b2; border-radius: 12px; padding: 30px; max-width: 600px; margin: 0 auto; }
    .header { text-align: center; border-bottom: 2px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 20px; }
    h1 { color: #0891b2; margin: 0; }
    .row { display: flex; margin: 12px 0; }
    .label { font-weight: 600; width: 150px; color: #6b7280; }
    .value { flex: 1; }
    .alert { background: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; margin: 20px 0; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <h1>üè• Patient Card</h1>
      <p>Medical Record</p>
    </div>
    
    <div class="row"><div class="label">Full Name:</div><div class="value"><strong>${currentPatient.basic_info.name}</strong></div></div>
    <div class="row"><div class="label">Patient ID:</div><div class="value">${currentPatient.id}</div></div>
    <div class="row"><div class="label">Date of Birth:</div><div class="value">${App.formatDateShort(currentPatient.basic_info.dob)}</div></div>
    <div class="row"><div class="label">Gender:</div><div class="value">${currentPatient.basic_info.gender}</div></div>
    <div class="row"><div class="label">Phone:</div><div class="value">${currentPatient.basic_info.phone}</div></div>
    <div class="row"><div class="label">Address:</div><div class="value">${currentPatient.basic_info.address || '-'}</div></div>
    <div class="row"><div class="label">Insurance:</div><div class="value">${currentPatient.basic_info.insurance || 'None'}</div></div>
    <div class="row"><div class="label">Assigned Doctor:</div><div class="value">${doctor ? 'Dr. ' + doctor.full_name : '-'}</div></div>
    
    ${currentPatient.basic_info.allergies ? `
      <div class="alert">
        <strong>‚ö†Ô∏è ALLERGIES:</strong> ${currentPatient.basic_info.allergies}
      </div>
    ` : ''}
    
    <div style="margin-top:30px;text-align:center;color:#6b7280;font-size:12px;">
      Issued on ${App.formatDate(App.timestamp())}<br>
      This is an official medical document
    </div>
  </div>
</body>
</html>`;

                App.savePDF(`patient_card_${currentPatient.basic_info.name.replace(/\s+/g, '_')}.html`, html);
                App.showToast('Printed', 'Patient card downloaded', 'success');
            };

            document.getElementById('refreshBtn').onclick = async () => {
                await loadPatients();
                await updateStats();
                App.showToast('Refreshed', 'Data updated', 'success', 2000);
            };

            document.getElementById('logoutBtn').onclick = () => {
                if (confirm('Logout?')) {
                    sessionStorage.removeItem('user');
                    location.href = '../index.html';
                }
            };
        })();
    </script>
</body>

</html>